<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guess Number Game</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="game-container">
        <h1>Guess Number Game</h1>
        <div id="room-section">
            <button id="create-room">Create Room</button>
            <input type="text" id="room-id" placeholder="Enter Room ID">
            <button id="join-room">Join Room</button>
        </div>
        <div id="game-section" style="display: none;">
            <div id="player-a-section">
                <h2>Player A</h2>
                <input type="number" id="digit-count" placeholder="Enter digit count (2-9)">
                <button id="set-digit">Set Digit Count</button>
                <input type="text" id="target-a" placeholder="Set your target number">
                <button id="set-target-a">Set Target</button>
                <input type="text" id="guess-a" placeholder="Guess Player B's number">
                <button id="submit-guess-a">Submit Guess</button>
                <div id="history-a"></div>
            </div>
            <div id="player-b-section">
                <h2>Player B</h2>
                <input type="text" id="target-b" placeholder="Set your target number">
                <button id="set-target-b">Set Target</button>
                <input type="text" id="guess-b" placeholder="Guess Player A's number">
                <button id="submit-guess-b">Submit Guess</button>
                <div id="history-b"></div>
            </div>
            <div id="result"></div>
            <button id="restart" style="display: none;">Restart Game</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
      // Import Firebase SDKs
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
      import { getDatabase, ref, set, onValue, push } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

      // Your Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyBRarN_Rj0EBhVQXj92w2x3wVuORcNXBuA",
        authDomain: "guess-number-game-a223f.firebaseapp.com",
        projectId: "guess-number-game-a223f",
        storageBucket: "guess-number-game-a223f.firebasestorage.app",
        messagingSenderId: "996802770979",
        appId: "1:996802770979:web:df1a401b5d92c85cdd1996"
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      // Game variables
      let roomId = null;
      let playerType = null; // 'A' or 'B'
      let digitCount = null;

      // Create a room
      document.getElementById('create-room').addEventListener('click', () => {
          roomId = Math.floor(1000 + Math.random() * 9000).toString();
          set(ref(db, 'rooms/' + roomId), {
              digitCount: null,
              targetA: null,
              targetB: null,
              guessesA: [],
              guessesB: [],
              winner: null
          });
          playerType = 'A';
          document.getElementById('room-section').style.display = 'none';
          document.getElementById('game-section').style.display = 'block';
          document.getElementById('player-a-section').style.display = 'block';
          document.getElementById('player-b-section').style.display = 'none';
          alert('Room created with ID: ' + roomId);
      });

      // Join a room
      document.getElementById('join-room').addEventListener('click', () => {
          roomId = document.getElementById('room-id').value;
          const roomRef = ref(db, 'rooms/' + roomId);
          onValue(roomRef, (snapshot) => {
              if (snapshot.exists()) {
                  playerType = 'B';
                  document.getElementById('room-section').style.display = 'none';
                  document.getElementById('game-section').style.display = 'block';
                  document.getElementById('player-a-section').style.display = 'none';
                  document.getElementById('player-b-section').style.display = 'block';
              } else {
                  alert('Room not found');
              }
          }, { onlyOnce: true });
      });

      // Set digit count (Player A only)
      document.getElementById('set-digit').addEventListener('click', () => {
          digitCount = parseInt(document.getElementById('digit-count').value);
          if (digitCount >= 2 && digitCount <= 9) {
              set(ref(db, 'rooms/' + roomId + '/digitCount'), digitCount);
          } else {
              alert('Please enter a digit count between 2 and 9');
          }
      });

      // Set target number for Player A
      document.getElementById('set-target-a').addEventListener('click', () => {
          const target = document.getElementById('target-a').value;
          if (target.length === digitCount && /^\d+$/.test(target)) {
              set(ref(db, 'rooms/' + roomId + '/targetA'), target);
          } else {
              alert('Please enter a valid ' + digitCount + '-digit number');
          }
      });

      // Set target number for Player B
      document.getElementById('set-target-b').addEventListener('click', () => {
          const target = document.getElementById('target-b').value;
          if (target.length === digitCount && /^\d+$/.test(target)) {
              set(ref(db, 'rooms/' + roomId + '/targetB'), target);
          } else {
              alert('Please enter a valid ' + digitCount + '-digit number');
          }
      });

      // Submit guess for Player A
      document.getElementById('submit-guess-a').addEventListener('click', () => {
          const guess = document.getElementById('guess-a').value;
          if (guess.length === digitCount && /^\d+$/.test(guess)) {
              const guessesRef = ref(db, 'rooms/' + roomId + '/guessesA');
              push(guessesRef, guess);
          } else {
              alert('Please enter a valid ' + digitCount + '-digit number');
          }
      });

      // Submit guess for Player B
      document.getElementById('submit-guess-b').addEventListener('click', () => {
          const guess = document.getElementById('guess-b').value;
          if (guess.length === digitCount && /^\d+$/.test(guess)) {
              const guessesRef = ref(db, 'rooms/' + roomId + '/guessesB');
              push(guessesRef, guess);
          } else {
              alert('Please enter a valid ' + digitCount + '-digit number');
          }
      });

      // Listen to room changes and update UI
      function listenToRoom() {
          const roomRef = ref(db, 'rooms/' + roomId);
          onValue(roomRef, (snapshot) => {
              const data = snapshot.val();
              if (data) {
                  digitCount = data.digitCount;
                  if (playerType === 'A') {
                      updateHistory('history-a', data.guessesA, data.targetB);
                      if (data.targetB && data.guessesA) {
                          checkWinner(data.guessesA, data.targetB, 'A');
                      }
                  } else {
                      updateHistory('history-b', data.guessesB, data.targetA);
                      if (data.targetA && data.guessesB) {
                          checkWinner(data.guessesB, data.targetA, 'B');
                      }
                  }
                  if (data.winner) {
                      document.getElementById('result').innerText = `Winner: Player ${data.winner}\nPlayer A's number: ${data.targetA}\nPlayer B's number: ${data.targetB}`;
                      document.getElementById('restart').style.display = 'block';
                  }
              }
          });
      }

      // Update guess history
      function updateHistory(elementId, guesses, target) {
          const historyDiv = document.getElementById(elementId);
          historyDiv.innerHTML = '';
          if (guesses && target) {
              Object.values(guesses).forEach((guess) => {
                  const hits = calculateHits(guess, target);
                  const p = document.createElement('p');
                  p.innerText = guess + ' -> ' + hits + ' hits';
                  historyDiv.appendChild(p);
              });
          }
      }

      // Calculate hits (correct digits in correct positions)
      function calculateHits(guess, target) {
          let hits = 0;
          for (let i = 0; i < digitCount; i++) {
              if (guess[i] === target[i]) {
                  hits++;
              }
          }
          return hits;
      }

      // Check for winner
      function checkWinner(guesses, target, player) {
          if (guesses && target) {
              Object.values(guesses).forEach((guess) => {
                  if (calculateHits(guess, target) === digitCount) {
                      set(ref(db, 'rooms/' + roomId + '/winner'), player);
                  }
              });
          }
      }

      // Restart game
      document.getElementById('restart').addEventListener('click', () => {
          set(ref(db, 'rooms/' + roomId), {
              digitCount: null,
              targetA: null,
              targetB: null,
              guessesA: [],
              guessesB: [],
              winner: null
          });
          document.getElementById('result').innerText = '';
          document.getElementById('restart').style.display = 'none';
      });

      // Start listening after creating or joining a room
      document.getElementById('create-room').addEventListener('click', listenToRoom, { once: true });
      document.getElementById('join-room').addEventListener('click', listenToRoom, { once: true });
    </script>
</body>
</html>